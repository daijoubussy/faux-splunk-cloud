# Splunk Docker default.yml Configuration
# Victoria Experience - Distributed Topology (Search Head + Indexer)
#
# This configuration is for distributed deployments with separate search head
# and indexer tiers, mimicking Splunk Cloud Victoria Experience.
#
# Reference: https://splunk.github.io/docker-splunk/ADVANCED.html
#
# Generated by Faux Splunk Cloud
# Instance: {{ instance_id }}
# Role: {{ role }}

splunk:
  # Build settings
  build:
    apps_url: []
    {% if preinstall_apps %}
    apps_url:
    {% for app_url in preinstall_apps %}
      - {{ app_url }}
    {% endfor %}
    {% endif %}

  # Cluster configuration
  {% if role == 'cluster_manager' %}
  cluster_manager:
    pass4SymmKey: "{{ cluster_secret }}"
    replication_factor: {{ replication_factor | default(1) }}
    search_factor: {{ search_factor | default(1) }}
  {% endif %}

  {% if role == 'indexer' %}
  idxc:
    pass4SymmKey: "{{ cluster_secret }}"
    replication_factor: {{ replication_factor | default(1) }}
    search_factor: {{ search_factor | default(1) }}
    cluster_manager_url: {{ cluster_manager_url }}
  {% endif %}

  {% if role == 'search_head' %}
  search_head:
    cluster_manager_url: {{ cluster_manager_url }}
  {% endif %}

  {% if role == 'deployer' %}
  deployer:
    pass4SymmKey: "{{ shc_secret }}"
  {% endif %}

  {% if role in ['search_head', 'shc_member'] and shc_enabled %}
  shc:
    pass4SymmKey: "{{ shc_secret }}"
    deployer_url: {{ deployer_url }}
    replication_factor: {{ shc_replication_factor | default(1) }}
    {% if shc_captain %}
    captain_url: {{ shc_captain_url }}
    {% endif %}
  {% endif %}

  # Splunk Enterprise configuration
  conf:
    # Server settings
    server:
      general:
        serverName: {{ hostname }}
        site: {{ site | default('site1') }}
      sslConfig:
        enableSplunkdSSL: true
        sslVersions: "tls1.2"
      {% if role == 'cluster_manager' %}
      clustering:
        mode: manager
        replication_factor: {{ replication_factor | default(1) }}
        search_factor: {{ search_factor | default(1) }}
        pass4SymmKey: "{{ cluster_secret }}"
      {% elif role == 'indexer' %}
      clustering:
        mode: peer
        manager_uri: {{ cluster_manager_url }}
        pass4SymmKey: "{{ cluster_secret }}"
      {% elif role in ['search_head', 'shc_member'] %}
      clustering:
        mode: searchhead
        manager_uri: {{ cluster_manager_url }}
        pass4SymmKey: "{{ cluster_secret }}"
      {% endif %}

    # Web settings
    web:
      settings:
        enableSplunkWebSSL: false
        httpport: 8000
        {% if role == 'indexer' %}
        # Indexers typically don't need web UI
        startwebserver: 0
        {% endif %}

    # Inputs configuration
    inputs:
      {% if role == 'indexer' %}
      # HEC configuration (indexers receive data)
      {% if enable_hec %}
      http:
        disabled: 0
        enableSSL: 1
        port: 8088
      {% endif %}
      # S2S receiving
      splunktcp:
        connection_host: dns
      "splunktcp://9997":
        connection_host: dns
        disabled: false
      {% endif %}

    # Indexes configuration (only on indexers)
    {% if role == 'indexer' %}
    indexes:
      {% for index in indexes %}
      {{ index.name }}:
        coldPath: $SPLUNK_DB/{{ index.name }}/colddb
        enableDataIntegrityControl: 0
        enableTsidxReduction: 0
        homePath: $SPLUNK_DB/{{ index.name }}/db
        maxTotalDataSizeMB: {{ index.maxTotalDataSizeMB | default(500000) }}
        thawedPath: $SPLUNK_DB/{{ index.name }}/thaweddb
        {% if index.datatype == 'metric' %}
        datatype: metric
        {% endif %}
        frozenTimePeriodInSecs: {{ index.frozenTimePeriodInSecs | default(7776000) }}
        # Clustering settings
        repFactor: auto
      {% endfor %}
    {% endif %}

    # Outputs configuration
    outputs:
      {% if role == 'search_head' %}
      # Search heads forward to indexers
      tcpout:
        defaultGroup: indexer-cluster
      "tcpout:indexer-cluster":
        server: {{ indexer_servers }}
        useACK: true
      {% endif %}

    # Distributed search configuration
    {% if role in ['search_head', 'shc_member'] %}
    distsearch:
      distributedSearch:
        servers: {{ search_peers }}
    {% endif %}

    # Limits configuration (Victoria defaults)
    limits:
      search:
        max_mem_usage_mb: {{ max_mem_usage_mb | default(4096) }}
        {% if enable_realtime_search %}
        indexed_realtime_default_span: 1
        indexed_realtime_disk_sync_delay: 60
        {% endif %}
      searchresults:
        maxresultrows: {{ max_result_rows | default(50000) }}

    # Authorization
    authorize:
      role_sc_admin:
        importRoles: admin
        srchIndexesAllowed: "*"
        srchIndexesDefault: main
        srchMaxTime: 0
      role_power:
        importRoles: power
        srchIndexesAllowed: "*"
        srchIndexesDefault: main
      role_user:
        importRoles: user
        srchIndexesAllowed: main;summary
        srchIndexesDefault: main

  # HEC token configuration (indexers only)
  {% if role == 'indexer' and hec_tokens %}
  hec:
    {% for token in hec_tokens %}
    {{ token.name }}:
      token: {{ token.token }}
      disabled: {{ 1 if token.disabled else 0 }}
      index: {{ token.defaultIndex | default('main') }}
      indexes: {{ token.indexes | join(';') if token.indexes else 'main' }}
      sourcetype: {{ token.defaultSourcetype | default('_json') }}
    {% endfor %}
  {% endif %}

  # User credentials
  password: "{{ admin_password }}"

  # Secret for cluster communication
  secret: "{{ cluster_secret }}"

  # License
  license_uri: "Free"

  # Role assignment
  role: splunk_{{ role }}

  # Smartstore configuration (disabled for ephemeral)
  smartstore: null

  # SSL configuration
  ssl:
    enable: true
    password: null

# Ansible settings
ansible:
  retry_num: 3
  retry_delay: 6
  timeout: 420
