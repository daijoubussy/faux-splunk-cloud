# Splunk Docker default.yml Configuration
# Victoria Experience - Standalone Topology
#
# This file configures a Splunk instance to mimic Splunk Cloud Victoria Experience.
# Reference: https://splunk.github.io/docker-splunk/ADVANCED.html
#
# Generated by Faux Splunk Cloud
# Instance: {{ instance_id }}

splunk:
  # Build settings
  build:
    apps_url: []
    {% if preinstall_apps %}
    apps_url:
    {% for app_url in preinstall_apps %}
      - {{ app_url }}
    {% endfor %}
    {% endif %}

  # Splunk Enterprise configuration
  conf:
    # Server settings
    server:
      general:
        serverName: {{ hostname }}
      sslConfig:
        enableSplunkdSSL: true
        sslVersions: "tls1.2"

    # Web settings
    web:
      settings:
        enableSplunkWebSSL: false
        httpport: 8000
        {% if enable_realtime_search %}
        # Victoria Experience: real-time search enabled by default
        {% endif %}

    # Inputs configuration
    inputs:
      # HEC configuration
      {% if enable_hec %}
      http:
        disabled: 0
        enableSSL: 1
        port: 8088
      {% endif %}
      # S2S receiving
      splunktcp:
        connection_host: dns
      "splunktcp://9997":
        connection_host: dns
        disabled: false

    # Indexes configuration (Victoria defaults)
    indexes:
      {% for index in indexes %}
      {{ index.name }}:
        coldPath: $SPLUNK_DB/{{ index.name }}/colddb
        enableDataIntegrityControl: 0
        enableTsidxReduction: 0
        homePath: $SPLUNK_DB/{{ index.name }}/db
        maxTotalDataSizeMB: {{ index.maxTotalDataSizeMB | default(500000) }}
        thawedPath: $SPLUNK_DB/{{ index.name }}/thaweddb
        {% if index.datatype == 'metric' %}
        datatype: metric
        {% endif %}
        frozenTimePeriodInSecs: {{ index.frozenTimePeriodInSecs | default(7776000) }}
      {% endfor %}

    # Outputs configuration (for forwarding topologies)
    outputs:
      tcpout:
        defaultGroup: default-autolb-group
      "tcpout:default-autolb-group":
        server: ""
        disabled: true

    # Limits configuration (Victoria defaults)
    limits:
      search:
        max_mem_usage_mb: {{ max_mem_usage_mb | default(4096) }}
        {% if enable_realtime_search %}
        # Real-time search settings (Victoria Experience default)
        indexed_realtime_default_span: 1
        indexed_realtime_disk_sync_delay: 60
        {% endif %}
      searchresults:
        maxresultrows: {{ max_result_rows | default(50000) }}

    # Authentication configuration
    authentication:
      authentication:
        authType: Splunk
        authSettings: splunk_auth

    # Authorize configuration (default roles)
    authorize:
      # sc_admin role (Splunk Cloud admin)
      role_sc_admin:
        importRoles: admin
        srchIndexesAllowed: "*"
        srchIndexesDefault: main
        srchMaxTime: 0
        cumulativeSrchJobsQuota: 0
        cumulativeRTSrchJobsQuota: 0
      # Standard power user role
      role_power:
        importRoles: power
        srchIndexesAllowed: "*"
        srchIndexesDefault: main
      # Standard user role
      role_user:
        importRoles: user
        srchIndexesAllowed: main;summary
        srchIndexesDefault: main

  # HEC token configuration
  {% if hec_tokens %}
  hec:
    {% for token in hec_tokens %}
    {{ token.name }}:
      token: {{ token.token }}
      disabled: {{ 1 if token.disabled else 0 }}
      index: {{ token.defaultIndex | default('main') }}
      indexes: {{ token.indexes | join(';') if token.indexes else 'main' }}
      sourcetype: {{ token.defaultSourcetype | default('_json') }}
      {% if token.useACK %}
      useACK: 1
      {% endif %}
    {% endfor %}
  {% endif %}

  # User credentials
  password: "{{ admin_password }}"

  # Post-start commands for Victoria-like setup
  {% if post_start_commands %}
  post_start:
  {% for cmd in post_start_commands %}
    - "{{ cmd }}"
  {% endfor %}
  {% endif %}

  # Secret for cluster communication
  secret: "{{ cluster_secret | default('faux-splunk-cloud-secret') }}"

  # License
  license_uri: "Free"

  # Role assignment (standalone has all roles)
  role: splunk_standalone

  # Smartstore configuration (disabled for ephemeral)
  smartstore: null

  # SSL configuration
  ssl:
    enable: true
    password: null

# Ansible settings (used by docker-splunk internally)
ansible:
  retry_num: 3
  retry_delay: 6
  timeout: 360
